language: rust
sudo: false

git:
  depth: 1

cache: cargo

os:
  - linux
  - osx
  - windows

rust:
- stable
- nightly

env:
  - CLIPPY="true"
  - CLIPPY=""

install:
  - if [ -n "$CLIPPY" ]; then rustup component add clippy-preview; fi

matrix:
  fast_finish: true
  exclude:
    - rust: stable
      env: CLIPPY="true"
    - rust: nightly
      env: CLIPPY=""
  allow_failures:
    - rust: nightly
    - os: windows

script:
  - if [ "$TRAVIS_OS_NAME" == "windows" ]; then choco install llvm --norestart --nosilent; fi
  - if [ -n "$CLIPPY" ]; then cargo clippy --all-features --all-targets; fi
  - if [ -z "$CLIPPY" ] && [ -n "$TRAVIS_TAG" ]; then cargo test --release; fi
  - if [ -z "$CLIPPY" ] && [ -z "$TRAVIS_TAG" ]; then cargo test; fi
  - if [ -z "$CLIPPY" ]; then cargo test -p font; fi

before_deploy:
  - ARCH=$(uname -m)
  - mkdir "./target/deploy"
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      make dmg;
      mv "./target/release/osx/Alacritty.dmg" "./target/deploy/Alacritty-$TRAVIS_TAG.dmg";
    fi
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      cargo install cargo-deb;
      DEB=$(cargo deb --no-build);
      mv "./target/release/alacritty" "./target/deploy/Alacritty-$TRAVIS_TAG-$ARCH";
      mv "$DEB" "./target/deploy/Alacritty-$TRAVIS_TAG-$ARCH.deb";
    fi
  - if [ "$TRAVIS_OS_NAME" == "windows" ]; then
      mv "./target/release/alacritty.exe" "./target/deploy/Alacritty-$TRAVIS_TAG-$ARCH.exe";
      mv "./target/release/winpty-agent.exe" "./target/deploy/winpty-agent.exe";
    fi

deploy:
  provider: releases
  api_key:
    secure: oHQYpFE9Ess83Q7+cO9U544BARN9SAaunE2RgEt5YR+KyFeW0wQfAKrdtMyv8BvAlFuk22VqdKlBEy537N9aZYPixOAyN/gcN9++4BsB2l9mqIlfU7EbAe6PdAGHlDiWgt1U7RAxJxdHC4auODDl2HFKZJAO8NQ94sM+/zmNp8xThKtbAm3j80fDIsFjCK562JlvlLtJHlEFFsPqyjJEfJi1BmAA+WpBcDwDzy5RGKnT0yKHShxh+iOEaOUeZTgtKkwr8ZTpaVTsQBbN/tw4JCBfyWFxsKb26DhWgrY3gmDq0DrrHeO1B38PREAK1MbWtbaQuN0XeOZp9NflBo+QxeRlIfYh+Zz8JDPBhBpJXp0xPwyH1BaeUoswSSkD6xANPxg6oMIe+z8W9wkCQz44nFyDaPgA0A+sdgtmJIYE9PvKirJPrjse+M0DAgm1Mzbm4g4HeJzAEIPnLp9STfLERXEmnUc+rVzuMboLjAW84bbO1cxLpfkSXsSx7Z1yqOKbmhi12WsSf5avQWJ95zv7+dnKBsZQx0xRqJ1agdPi80XgvFm4juX5plxKjipNZNXR9hbjK94qAqY/6/2RYmzZ7L+e31mVkkxLW/mVEp1h+VO0kBkZErNLjz6/WqzHIfG5yFr/OnbkGDVmq2BVJdE7JlfcaMEWMeTA0USr0dqYC7U=
  skip_cleanup: true
  file_glob: true
  file: "./target/deploy/*"
  on:
    tags: true
    rust: stable
