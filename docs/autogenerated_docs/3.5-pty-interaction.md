# PTY Interaction

<details>
<summary>Relevant source files</summary>

The following files were used as context for generating this wiki page:

- [alacritty_terminal/src/event_loop.rs](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs)
- [alacritty_terminal/src/tty/mod.rs](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/mod.rs)
- [alacritty_terminal/src/tty/unix.rs](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs)
- [alacritty_terminal/src/tty/windows/child.rs](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/child.rs)
- [alacritty_terminal/src/tty/windows/conpty.rs](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/conpty.rs)
- [alacritty_terminal/src/tty/windows/mod.rs](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/mod.rs)

</details>



This page documents how Alacritty interacts with pseudoterminals (PTYs), which form the communication bridge between the terminal emulator interface and the shell processes running within it. For information about the terminal core itself, see [Terminal Core](#3.2), and for details on how events are processed, see [Event System](#3.3).

## Overview of PTY in Terminal Emulation

A pseudoterminal (PTY) is a pair of virtual character devices that provides a bidirectional communication channel between the terminal emulator (master end) and processes running in the terminal (slave end). Alacritty's PTY subsystem is responsible for:

1. Creating platform-specific PTY instances
2. Spawning and connecting to shell processes
3. Handling bidirectional I/O between the terminal and shell
4. Managing terminal resize events
5. Detecting and handling child process termination

```mermaid
graph LR
    A["Alacritty Terminal"] <--> B["PTY Master"]
    B <--> C["PTY Slave"]
    C <--> D["Shell Process"]
    
    subgraph "Alacritty Process"
        A
        B
    end
    
    subgraph "Child Process"
        C
        D
    end

    A -- "Writes User Input" --> B
    B -- "Data appears at" --> C
    C -- "Shell reads input" --> D
    D -- "Outputs to" --> C
    C -- "Data appears at" --> B
    B -- "Terminal reads output" --> A
```

Sources: [alacritty_terminal/src/tty/mod.rs:1-146](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/mod.rs#L1-L146), [alacritty_terminal/src/event_loop.rs:1-486](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs#L1-L486)

## Cross-Platform Abstraction

Alacritty implements a cross-platform abstraction layer for PTY interaction, with platform-specific implementations for Unix and Windows systems.

```mermaid
classDiagram
    class EventedReadWrite {
        <<trait>>
        +register()
        +reregister()
        +deregister()
        +reader()
        +writer()
    }
    
    class EventedPty {
        <<trait>>
        +next_child_event()
    }
    
    class OnResize {
        <<trait>>
        +on_resize()
    }
    
    class Pty {
        -file: File
        -child: Child
        -signals: UnixStream
        +child()
        +file()
    }
    
    class WindowsPty {
        -backend: Backend
        -conout: ReadPipe
        -conin: WritePipe
        -child_watcher: ChildExitWatcher
    }
    
    EventedReadWrite <|-- EventedPty
    EventedPty <|.. Pty
    EventedPty <|.. WindowsPty
    OnResize <|.. Pty
    OnResize <|.. WindowsPty
```

Sources: [alacritty_terminal/src/tty/mod.rs:52-89](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/mod.rs#L52-L89), [alacritty_terminal/src/tty/unix.rs:103-118](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L103-L118), [alacritty_terminal/src/tty/windows/mod.rs:27-53](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/mod.rs#L27-L53)

### Core Traits

The PTY subsystem defines several key traits that abstract platform-specific behavior:

| Trait | Purpose | Key Methods |
|-------|---------|-------------|
| `EventedReadWrite` | Provides an abstraction over stream read/write operations | `register()`, `reregister()`, `deregister()`, `reader()`, `writer()` |
| `EventedPty` | Extends `EventedReadWrite` with child process event notifications | `next_child_event()` |
| `OnResize` | Handles PTY size changes | `on_resize()` |

The platform-specific implementations of these traits handle the details of PTY management on each supported platform.

Sources: [alacritty_terminal/src/tty/mod.rs:57-89](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/mod.rs#L57-L89)

## PTY Creation and Setup

### Unix PTY Creation

On Unix systems, Alacritty creates a PTY using the `openpty` function, which returns a master and slave file descriptor pair.

```mermaid
flowchart TD
    A["new()"] --> B["openpty()"]
    B --> C["from_fd()"]
    C --> D["Get shell user info"]
    D --> E{"Config has shell?"}
    E -- "Yes" --> F["Use specified shell"]
    E -- "No" --> G["Use default shell"]
    F --> H["Setup child process"]
    G --> H
    H --> I["Child process pre_exec()"]
    I --> J["Set session ID"]
    J --> K["Set controlling terminal"]
    K --> L["Setup signal handling"]
    L --> M["Spawn child process"]
    M --> N["Create Pty struct"]
```

Sources: [alacritty_terminal/src/tty/unix.rs:196-304](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L196-L304)

The Unix implementation includes setting up the terminal attributes, creating a new process group, and handling signals.

### Windows PTY Creation

On Windows, Alacritty uses the ConPTY API to create a pseudoconsole instance:

```mermaid
flowchart TD
    A["new()"] --> B["ConptyApi::new()"]
    B --> C["Create anonymous pipes"]
    C --> D["Create pseudoconsole"]
    D --> E["Prepare child process startup info"]
    E --> F["Initialize thread attribute list"]
    F --> G["Set pseudoconsole attribute"]
    G --> H["Prepare command line"]
    H --> I["Create process"]
    I --> J["Create unblocker wrappers"]
    J --> K["Create child watcher"]
    K --> L["Create Pty struct"]
```

Sources: [alacritty_terminal/src/tty/windows/conpty.rs:110-244](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/conpty.rs#L110-L244)

## PTY I/O Operations

The PTY I/O operations are managed by the event loop, which performs reading and writing operations between the terminal and the shell process:

```mermaid
flowchart LR
    A["EventLoop"] --> B["poll()"]
    B --> C{"Event type?"}
    C -- "Readable" --> D["pty_read()"]
    C -- "Writable" --> E["pty_write()"]
    C -- "Child event" --> F["next_child_event()"]
    D --> G["terminal.lock()"]
    G --> H["parser.advance()"]
    E --> I["pty.writer().write()"]
    F --> J["child.try_wait()"]
```

Sources: [alacritty_terminal/src/event_loop.rs:104-203](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs#L104-L203), [alacritty_terminal/src/event_loop.rs:228-316](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs#L228-L316)

### Reading from PTY

The `pty_read` function reads data from the PTY and processes it through the terminal parser:

1. Reads data from the PTY in non-blocking mode
2. Attempts to lock the terminal for updates
3. Passes the read bytes to the terminal parser
4. Schedules a terminal redraw when new content is processed

Sources: [alacritty_terminal/src/event_loop.rs:104-171](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs#L104-L171)

### Writing to PTY

The `pty_write` function writes user input to the PTY:

1. Takes data from a write queue
2. Writes as much data as possible to the PTY
3. Handles partial writes by buffering remaining data
4. Handles blocking and errors

Sources: [alacritty_terminal/src/event_loop.rs:174-203](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs#L174-L203)

## Terminal Resizing

Both Unix and Windows implementations support terminal resizing:

### Unix Resizing
On Unix systems, terminal resizing is implemented using the `TIOCSWINSZ` ioctl to update the kernel's representation of the terminal size.

```
OnResize::on_resize() 
â†’ ioctl(file_descriptor, TIOCSWINSZ, winsize)
```

Sources: [alacritty_terminal/src/tty/unix.rs:403-417](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L403-L417), [alacritty_terminal/src/tty/unix.rs:425-434](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L425-L434)

### Windows Resizing
On Windows, terminal resizing is implemented using the ConPTY API's `ResizePseudoConsole` function.

```
OnResize::on_resize() 
â†’ ResizePseudoConsole(handle, window_size)
```

Sources: [alacritty_terminal/src/tty/windows/conpty.rs:303-308](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/conpty.rs#L303-L308), [alacritty_terminal/src/tty/windows/conpty.rs:310-316](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/conpty.rs#L310-L316)

## Child Process Management

### Spawning Shell Process

The PTY subsystem is responsible for spawning the shell process and connecting it to the PTY:

1. Determines which shell to use based on configuration
2. Sets up environment variables
3. Connects the shell's standard I/O to the slave end of the PTY
4. Spawns the shell process

Sources: [alacritty_terminal/src/tty/unix.rs:215-302](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L215-L302), [alacritty_terminal/src/tty/windows/conpty.rs:204-235](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/conpty.rs#L204-L235)

### Platform-Specific Shell Selection

```mermaid
flowchart TD
    A{"Config has shell?"}
    A -- Yes --> B["Use specified shell"]
    A -- No --> C{"Platform?"}
    C -- Unix --> D["Check $SHELL env or passwd"]
    C -- Windows --> E["Use powershell"]
    D --> F["Create shell command"]
    E --> F
    B --> F
    F --> G["Add shell arguments"]
    G --> H["Spawn process"]
```

Sources: [alacritty_terminal/src/tty/unix.rs:127-159](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L127-L159), [alacritty_terminal/src/tty/windows/mod.rs:128-136](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/mod.rs#L128-L136)

### Child Process Exit Detection

Alacritty detects child process exit differently on Unix and Windows:

#### Unix Exit Detection
On Unix, exit detection uses signal handling with `SIGCHLD` to detect when the child process exits.

Sources: [alacritty_terminal/src/tty/unix.rs:276-282](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L276-L282), [alacritty_terminal/src/tty/unix.rs:381-400](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L381-L400)

#### Windows Exit Detection
On Windows, exit detection uses the `RegisterWaitForSingleObject` API to get notified when the child process handle becomes signaled.

Sources: [alacritty_terminal/src/tty/windows/child.rs:31-48](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/child.rs#L31-L48), [alacritty_terminal/src/tty/windows/child.rs:58-92](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/child.rs#L58-L92)

## Event Loop Integration

The PTY subsystem integrates with Alacritty's event loop to handle I/O and events:

```mermaid
sequenceDiagram
    participant A as "EventLoop"
    participant B as "Pty"
    participant C as "Terminal"
    participant D as "Shell Process"
    
    A->>A: Initialize
    A->>B: register()
    loop Event Loop
        A->>A: poll()
        alt Readable Event
            A->>B: reader().read()
            B->>D: Read from PTY
            A->>C: parser.advance()
            A->>A: Send Event::Wakeup
        else Writable Event
            A->>A: Get pending writes
            A->>B: writer().write()
            B->>D: Write to PTY
        else Child Event
            A->>B: next_child_event()
            B->>A: ChildEvent::Exited
            A->>C: terminal.exit()
            A->>A: Send Event::ChildExit
        end
    end
```

Sources: [alacritty_terminal/src/event_loop.rs:205-323](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/event_loop.rs#L205-L323)

## Platform-Specific Implementations

### Unix Implementation

On Unix systems, Alacritty uses the standard PTY mechanism with:
- Master and slave file descriptors
- Signal-based child process monitoring
- IOCTL-based terminal resizing

This implementation involves:
1. Creating a PTY pair using `openpty()`
2. Setting terminal attributes
3. Creating a new session with `setsid()`
4. Setting the PTY as the controlling terminal
5. Spawning the shell process
6. Handling I/O through the master file descriptor

Sources: [alacritty_terminal/src/tty/unix.rs:196-304](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L196-L304), [alacritty_terminal/src/tty/unix.rs:320-377](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/unix.rs#L320-L377)

### Windows Implementation

On Windows, Alacritty uses the ConPTY API with:
- Pseudoconsole handle
- Anonymous pipes for I/O
- Event-based child process monitoring

This implementation involves:
1. Creating anonymous pipes for input and output
2. Creating a pseudoconsole using `CreatePseudoConsole()`
3. Setting up process attributes to use the pseudoconsole
4. Creating the shell process
5. Using non-blocking wrappers for pipe I/O
6. Registering for child process exit notifications

Sources: [alacritty_terminal/src/tty/windows/conpty.rs:110-244](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/conpty.rs#L110-L244), [alacritty_terminal/src/tty/windows/mod.rs:60-126](https://github.com/alacritty/alacritty/blob/a0c4dfe9/alacritty_terminal/src/tty/windows/mod.rs#L60-L126)

## Summary

The PTY subsystem in Alacritty provides a cross-platform abstraction for interacting with pseudoterminals, handling the complexities of different operating systems behind a consistent interface. It manages PTY creation, shell process spawning, I/O operations, terminal resizing, and child process exit detection, allowing the terminal emulator to communicate effectively with the shell process regardless of the underlying platform.